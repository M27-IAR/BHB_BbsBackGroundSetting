// æ ¸å¿ƒå˜é‡
var k = 0, c = "", name = "", key = "";
let autoScroll = true;
let userScrolling = false; // æ·»åŠ ç”¨æˆ·æ»šåŠ¨æ ‡è®°
var messageIds = new Set();
// æ·»åŠ  AI ç›¸å…³å¸¸é‡
const AI_NAME = 'AIåŠ©æ‰‹';
const AI_AVATAR = './plugin/msto_chat/assets/ai.png';

// æ·»åŠ åˆ†é¡µç›¸å…³å˜é‡
let currentPage = 1;
let isLoading = false;
let hasMore = true;
const perPage = 10;
let lastMsgId = null; // æ·»åŠ æœ€åä¸€æ¡æ¶ˆæ¯IDçš„è®°å½•

// åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ  LetterAvatar å‡½æ•°
function LetterAvatar(name, size) {
    const colors = [
        "#1abc9c", "#2ecc71", "#3498db", "#9b59b6", "#34495e", "#16a085",
        "#27ae60", "#2980b9", "#8e44ad", "#2c3e50", "#f1c40f", "#e67e22",
        "#e74c3c", "#95a5a6", "#f39c12", "#d35400", "#c0392b", "#bdc3c7"
    ];
    
    const nameSplit = name.split(" ");
    const initials = nameSplit.length > 1 ? 
        nameSplit[0].charAt(0) + nameSplit[1].charAt(0) : 
        name.charAt(0);
    
    const charIndex = initials.charCodeAt(0) - 65;
    const colorIndex = Math.abs(charIndex) % colors.length;
    
    // ä¸ºç³»ç»Ÿæ¶ˆæ¯è¿”å›ç‰¹ï¿½ï¿½ï¿½å›¾æ ‡
    if(name === 'System') {
        return `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="%23666"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>`;
    }
    
    // ç”Ÿæˆå¸¦æœ‰åˆå§‹å­—æ¯çš„å¤´åƒ
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    canvas.width = size;
    canvas.height = size;
    
    // ç»˜åˆ¶èƒŒæ™¯
    context.fillStyle = colors[colorIndex];
    context.fillRect(0, 0, canvas.width, canvas.height);
    
    // ç»˜åˆ¶æ–‡å­—
    context.font = Math.floor(size/2) + 'px Arial';
    context.fillStyle = '#ffffff';
    context.textAlign = 'center';
    context.textBaseline = 'middle';
    context.fillText(initials.toUpperCase(), size/2, size/2);
    
    return canvas.toDataURL();
}

// åœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ å·¥å…·æ åˆ‡æ¢ç›¸å…³ä»£ç 
$(document).ready(function() {
    // å·¥å…·æ åˆ‡æ¢åŠŸèƒ½
    $('.toggle-toolbar').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const $toolbar = $('.chat-toolbar');
        
        // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€å¹¶æ·»åŠ åŠ¨ç”»
        if($toolbar.is(':visible')) {
            $toolbar.css({
                'max-height': '0',
                'opacity': '0',
                'padding': '0 10px'
            });
            setTimeout(() => {
                $toolbar.hide();
            }, 300);
        } else {
            $toolbar.show().css({
                'display': 'flex',
                'max-height': '46px',
                'opacity': '1',
                'padding': '8px 10px'
            });
        }
        
        localStorage.setItem('toolbarVisible', $toolbar.is(':visible'));
    });

    // ä» localStorage æ¢å¤å·¥å…·æ çŠ¶æ€
    if(localStorage.getItem('toolbarVisible') === 'true') {
        const $toolbar = $('.chat-toolbar');
        $toolbar.show().css({
            'display': 'flex',
            'max-height': '46px',
            'opacity': '1',
            'padding': '8px 10px'
        });
    }

    // é˜»æ­¢å·¥å…·æ çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
    $('.chat-toolbar').on('click', function(e) {
        e.stopPropagation();
    });

    // ä¿®æ”¹å‘é€æ¶ˆæ¯çš„è§¦å‘æ–¹å¼
    $("#msg").on("keypress", function(e) {
        if (e.keyCode === 13 && !e.shiftKey) {
            e.preventDefault();
            send();
        }
    });
});

// å›¾ç‰‡ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
$('.chat-toolbar .image-btn').on('click', function() {
    $('.chat-toolbar #imageUpload').click();
});

// å›¾ç‰‡æ–‡ä»¶é€‰æ‹©äº‹ä»¶
$('.chat-toolbar #imageUpload').on('change', function(e) {
    const file = e.target.files[0];
    if(!file) return;
    
    console.log('Selected file:', file);
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    if(!file.type.match(/^image\/(jpeg|png|gif|avif|webp)$/)) {
        alert('åªæ”¯æŒ jpgã€pngã€gifã€avifã€webp æ ¼å¼çš„å›¾ç‰‡');
        return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
    if(file.size > 5 * 1024 * 1024) {
        alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
        return;
    }
    
    const formData = new FormData();
    formData.append('image', file);
    
    // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
    const progressHtml = `
        <div class="upload-progress" style="
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
        ">
            <div>æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...</div>
            <div class="progress-text">0%</div>
        </div>
    `;
    $('body').append(progressHtml);
    
    console.log('Starting upload...');
    $.ajax({
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=upload",
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        xhr: function() {
            const xhr = new XMLHttpRequest();
            xhr.upload.addEventListener("progress", function(e) {
                if(e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    $('.progress-text').text(percent + '%');
                    console.log('Upload progress:', percent + '%');
                }
            });
            return xhr;
        },
        success: function(response) {
            $('.upload-progress').remove();
            console.log('Upload response:', response);
            
            if(response.error) {
                alert(response.error);
                return;
            }
            if(response.url) {
                console.log('Image URL:', response.url);
                const imgMsg = `<img src="${response.url}" style="max-width:200px; max-height:200px; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2);" />`;
                console.log('Image message:', imgMsg);
                $("#msg").val(imgMsg);
                send();
            }
        },
        error: function(xhr, status, error) {
            $('.upload-progress').remove();
            console.error('Upload failed:', error);
            console.error('Response:', xhr.responseText);
            alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
    
    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸ä¸Šä¼ æ–‡ä»¶
    $(this).val('');
});

// æ·»åŠ æŒ‰é’®hoveræ•ˆæœ
$('.chat-toolbar .toolbar-btn').hover(
    function() {
        $(this).css({
            'background': 'var(--bs-primary, #0d6efd)',
            'box-shadow': '0 2px 5px rgba(0,0,0,0.15)',
            'border-color': 'var(--bs-primary, #0d6efd)',
            'color': 'var(--bs-white, #fff)'
        });
    },
    function() {
        $(this).css({
            'background': 'var(--bs-body-bg, #fff)',
            'box-shadow': '0 1px 3px rgba(0,0,0,0.1)',
            'border-color': 'var(--bs-border-color, #ddd)',
            'color': 'var(--bs-body-color, #333)'
        });
    }
);

// å‘é€æ¶ˆæ¯
function send() {
    if ($("#msg").val().length < 1) return false;
    
    let msgContent = $("#msg").val();
    // å¤„ç†Bç«™é“¾æ¥
    msgContent = parseBilibiliUrl(msgContent);
    let isAIMessage = msgContent.match(/^@AIåŠ©æ‰‹\s+/i);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    $("#msg").val("");
    
    // å¦‚æœæ˜¯AIå¯¹è¯ï¼Œå…ˆç¦ç”¨è¾“å…¥æ¡†
    if (isAIMessage) {
        $("#msg").prop('disabled', true)
                .attr('placeholder', 'AIåŠ©æ‰‹æ­£åœ¨æ€ï¿½ï¿½ä¸­...');
        showAITyping();
    }
    
    $.ajax({
        type: 'POST',
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=send",
        data: { msg: msgContent },
        dataType: 'json',
        success: function(response) {
            if(response.error) {
                alert(response.error);
                // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œæ¢å¤è¾“å…¥æ¡†çŠ¶æ€
                if (isAIMessage) {
                    $("#msg").prop('disabled', false)
                            .attr('placeholder', 'è¯·è¾“å…¥æ¶ˆæ¯...');
                    removeAITyping();
                }
                // å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œæ¢å¤æ¶ˆæ¯å†…å®¹
                $("#msg").val(msgContent);
                return;
            }
            
            // å‘é€æˆåŠŸåé‡ç½®æ»šåŠ¨çŠ¶æ€
            autoScroll = true;
            userScrolling = false;
            currentPage = 1;
            get_msg();
            
            // å¦‚æœä¸æ˜¯AIå¯¹è¯ï¼Œä¿æŒè¾“å…¥æ¡†ç„¦ç‚¹
            if (!isAIMessage) {
                $("#msg").focus();
            }
        },
        error: function(xhr, status, error) {
            console.error('å‘é€å¤±è´¥:', error);
            alert('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
            // å‘é€å¤±è´¥æ—¶æ¢å¤è¾“å…¥æ¡†çŠ¶æ€å’Œæ¶ˆæ¯å†…ï¿½ï¿½
            if (isAIMessage) {
                $("#msg").prop('disabled', false)
                        .attr('placeholder', 'è¯·è¾“å…¥æ¶ˆæ¯...');
                removeAITyping();
            }
            $("#msg").val(msgContent);
        }
    });
    return false;
}

// è‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½
function sockll() {
    if(autoScroll && !userScrolling) {
        $(".chat-history-body").scrollTop($(".chat-history-body")[0].scrollHeight);
    }
}

// ä¿®æ”¹æ»šåŠ¨äº‹ä»¶å¤„ç†
$(".chat-history-body").on('scroll', function() {
    const element = $(this)[0];
    const atBottom = element.scrollHeight - element.scrollTop <= element.clientHeight + 100;
    
    // åªæœ‰å½“ç”¨æˆ·ä¸»åŠ¨æ»šåŠ¨æ—¶æ‰æ›´æ–°autoScroll
    if(userScrolling) {
        autoScroll = atBottom;
    }
});

// ä¿®æ”¹ get_msg å‡½æ•°
function get_msg() {
    if (!document.hidden && !isLoading) {
        const baseUrl = document.querySelector('.mk-chat-box').getAttribute('data-base-href');
        const url = `${baseUrl}app/ajax.php?c=msg&page=${currentPage}&per_page=${perPage}`;
        
        isLoading = true;
        
        $.getJSON(url).done(function(response) {
            if(!response || !response.list || response.list.length === 0) {
                isLoading = false;
                return;
            }
            
            hasMore = response.hasMore;
            const currentMessageIds = new Set();
            let hasNewAIResponse = false;
            let hasNewMessages = false;
            
            // å¦‚æœæ˜¯ç¬¬ä¸€é¡µï¼Œæ¸…ç©ºç°æœ‰æ¶ˆæ¯
            if(currentPage === 1) {
                $('.mk-chat-box').empty();
                messageIds.clear();
            }
            
            // å¦‚æœæ˜¯åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯ï¼Œè®°å½•å½“å‰æ»šåŠ¨ä½ç½®
            const scrollPos = currentPage > 1 ? $(".chat-history-body").scrollTop() : 0;
            
            // å¤„ç†æ¶ˆæ¯åˆ—è¡¨
            response.list.forEach(function(msgStr) {
                try {
                    const msg = JSON.parse(msgStr);
                    currentMessageIds.add(msg.id);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ¶ˆæ¯
                    if (currentPage === 1 && lastMsgId && msg.id > lastMsgId) {
                        hasNewMessages = true;
                        
                        // åªæœ‰æ–°æ¶ˆæ¯ä¸”åŒ…å«@æ—¶æ‰æ’­æ”¾æç¤ºéŸ³
                        if (msg.msg.includes('@' + name) && 
                            msg.name !== name && 
                            !msg.msg.includes('<img') && 
                            !msg.msg.includes('<audio') &&
                            !messageIds.has(msg.id)) {
                            playSound();
                        }
                    }
                    
                    if(!messageIds.has(msg.id)) {
                        messageIds.add(msg.id);
                        
                        if(msg.type === 'ai') {
                            hasNewAIResponse = true;
                        }
                        
                        const messageClass = (msg.key === key || msg.name === name) ? "right chat-message-right" : "left";
                        const avatar = msg.pic || LetterAvatar(msg.name, 32);
                        
                        // æ ¹æ®é¡µç å†³å®šæ·»åŠ ä½ç½®
                        if(currentPage > 1) {
                            prependMessage(msg.name, msg, messageClass, avatar);
                        } else {
                            addmsg(msg.name, msg, messageClass, avatar);
                        }
                    }
                } catch(e) {
                    console.error('æ¶ˆæ¯è§£æå¤±è´¥:', e, msgStr);
                }
            });
            
            // æ›´æ–°æœ€åæ¶ˆæ¯ID
            if (response.list.length > 0) {
                try {
                    const lastMsg = JSON.parse(response.list[response.list.length - 1]);
                    lastMsgId = lastMsg.id;
                } catch(e) {
                    console.error('è§£ææœ€åæ¶ˆæ¯IDå¤±è´¥:', e);
                }
            }
            
            // æ¢å¤è¾“å…¥æ¡†çŠ¶æ€
            if(hasNewAIResponse || hasNewMessages) {
                $("#msg").prop('disabled', false)
                        .attr('placeholder', 'è¯·è¾“å…¥æ¶ˆæ¯...')
                        .focus();
                removeAITyping();
            }
            
            // æ›´æ–°åŠ è½½æ›´å¤šæŒ‰é’®
            updateLoadMoreButton();
            
            // æ›´æ–°æ»šåŠ¨ä½ç½®
            if(currentPage > 1) {
                // åŠ è½½å†å²æ¶ˆæ¯æ—¶ï¼Œä¿æŒåœ¨åŸä½ç½®
                userScrolling = true;
                $(".chat-history-body").scrollTop(scrollPos);
                setTimeout(() => {
                    userScrolling = false;
                }, 100);
            } else if(hasNewMessages) {
                // æ–°æ¶ˆæ¯æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
                autoScroll = true;
                userScrolling = false;
                sockll();
            }
            
            isLoading = false;
        });
    }
}

// ä¿®æ”¹æ¶ˆæ¯æ·»åŠ å‡½æ•°
function addmsg(name, content, messageClass, avatar) {
    const messageHtml = createMessageHtml(name, content, messageClass, avatar, content.id);
    $(".mk-chat-box").append(messageHtml);
}

// ä¿®æ”¹å‘é¡¶éƒ¨æ·»åŠ æ¶ˆæ¯çš„å‡½æ•°
function prependMessage(name, content, messageClass, avatar) {
    const messageHtml = createMessageHtml(name, content, messageClass, avatar, content.id);
    $(".mk-chat-box").prepend(messageHtml);
}

// ä¿®æ”¹æ¶ˆæ¯HTMLåˆ›å»ºå‡½æ•°
function createMessageHtml(name, content, messageClass, avatar, index) {
    const profileUrl = '#';
    const recallButton = (name === window.name || window.isAdmin) ? 
        `<button class="recall-btn" data-message-id="${content.id}" style="
            font-size: 12px;
            padding: 2px 8px;
            border: none;
            background: none;
            color: #666;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            margin-left: 8px;
        ">æ’¤å›</button>` : '';

    return `
        <li class="chat-message ${messageClass}" data-index="${content.id}">
            <div class="d-flex overflow-hidden">
                <div class="user-avatar flex-shrink-0 me-4">
                    <div class="avatar avatar-sm">
                        <a href="javascript:void(0)" onclick="window.open('${profileUrl}','_blank')">
                            <img src="${avatar}" alt="Avatar" class="rounded-circle">
                        </a>
                    </div>
                </div>
                <div class="chat-message-wrapper flex-grow-1">
                    <div class="text-muted mb-1 d-flex justify-content-between align-items-center">
                        <small title="å³é”®ç‚¹å‡»ç®¡ç†" style="cursor:pointer" onclick="document.getElementById('msg').value = document.getElementById('msg').value + '@' + this.textContent + '  '">${name}</small>
                        ${recallButton}
                    </div>
                    <div class="chat-message-text">
                        <div class="mb-0">${content.msg}</div>
                    </div>
                </div>
            </div>
        </li>
    `;
}

// ä¿®æ”¹åŠ è½½æ›´å¤šæŒ‰é’®çš„å¤„ç†
function updateLoadMoreButton() {
    // ç§»é™¤ç°æœ‰çš„åŠ è½½æ›´å¤šæŒ‰é’®
    $('.load-more-btn').remove();
    
    if(hasMore) {
        const loadMoreBtn = `
            <div class="load-more-btn" style="
                text-align: center;
                padding: 5px 10px;
                margin: 5px auto;
                background: var(--bs-primary-soft, #e7f1ff);
                color: var(--bs-primary);
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                transition: all 0.2s;
                width: fit-content;
                border: 1px solid var(--bs-primary-border-subtle, #9ec5fe);
            ">
                <i class="la la-angle-up" style="margin-right: 4px;"></i>åŠ è½½æ›´å¤š
            </div>
        `;
        $('.mk-chat-box').prepend(loadMoreBtn);
    }
}

// ä¿®æ”¹åŠ è½½æ›´å¤šæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
$(document).on('click', '.load-more-btn', function() {
    if(!isLoading && hasMore) {
        userScrolling = true; // æ ‡è®°ç”¨æˆ·æ“ä½œ
        $(this).html('<i class="la la-spinner la-spin"></i> åŠ è½½ä¸­...')
               .css('opacity', '0.7')
               .css('pointer-events', 'none');
        currentPage++;
        get_msg();
    }
});

// æ·»åŠ å‘é¡¶éƒ¨æ·»åŠ æ¶ˆæ¯çš„å‡½æ•°
function prependMessage(name, content, messageClass, avatar) {
    const messageHtml = createMessageHtml(name, content, messageClass, avatar, content.id);
    $(".mk-chat-box").prepend(messageHtml);
}

// æ·»åŠ å»¶è¿ŸåŠ è½½UIç»„ä»¶çš„å‡½æ•°
function loadDeferredUI() {
    // å»¶è¿ŸåŠ è½½è¡¨åŒ…ç›¸å…³
    loadEmojis();
    // å»¶è¿ŸåŠ è½½å·¥å…·æ 
    loadToolbar();
}

// ä¿®æ”¹åˆå§‹åŒ–å‡½æ•°
$(document).ready(function() {
    if(c) clearInterval(c);
    
    // é‡ç½®åˆ†é¡µç›¸å…³å˜é‡
    currentPage = 1;
    isLoading = false;
    hasMore = true;
    
    // å…ˆæ‰§è¡Œç™»å½•ï¼Œåœ¨ç™»å½•æˆåŠŸåç«‹å³è·å–æ¶ˆæ¯
    if ($('.login').length == 0) {
        login();
    }
    
    $("#msg").on("keypress", function(a) {
        if (13 == a.keyCode) return send(), false;
    });
});

// ä¿®æ”¹ç™»å½•å‡½æ•°ï¼Œç¡®ä¿è·å–æ¶ˆæ¯
function login(n) {
    $.get(document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=login", { 'n': n })
        .done(function(response) {
            if(typeof response === 'string') {
                response = JSON.parse(response);
            }
            name = response.name;
            key = response.key;
            window.isAdmin = Boolean(response.isAdmin);
            
            // ç«‹å³è·å–ä¸€æ¬¡æ¶ˆæ¯
            get_msg();
            
            // åå¼€å§‹å®šæ—¶è·å–
            if(!c) {
                c = setInterval(get_msg, 2000);
            }
            
            // æ·»åŠ é¢å¯è§æ€§æ£€æµ‹
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    get_msg();
                }
            });
            
            // å»¶è¿Ÿè½½å…¶ä»–UIç»„ä»¶
            setTimeout(loadDeferredUI, 1000);
            
            // æ·»åŠ åˆ·æ–°æ£€æŸ¥(æ›´é¢‘ç¹æ£€æŸ¥)
            setInterval(checkForceRefresh, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
        });
}

// åˆ†ç¦»UIåŠ è½½å‡½æ•°
function loadEmojis() {
    // å»¶è¿ŸåŠ è½½è¡¨æƒ…åŒ…æ•°å’ŒUI
    setTimeout(() => {
        // åŸæ¥çš„è¡¨æƒ…åŒ…åˆå§‹åŒ–ä»£ç 
        const emojis = {
            'ğŸ˜€': 'å¼€å¿ƒ', 'ğŸ˜ƒ': 'å¤§ç¬‘'
            // ... å…¶ä»–æƒ…
        };
        // ... è¡¨æƒ…åŒ…ç›¸å…³ä»£ç 
    }, 1000);
}

function loadToolbar() {
    // å»¶è¿ŸåŠ è½½å·¥å…·æ 
    setTimeout(() => {
        // åŸæ¥çš„å·¥å…·æ åˆå§‹åŒ–ä»£ç 
        $('.chat-toolbar').show();
    }, 1500);
}

// ä¿®æ”¹å³é”®èœå•HTML
$('body').find('.custom-menu').remove();
$('body').append(`
    <div class="custom-menu" style="
        display: none;
        position: absolute;
        background: var(--bs-body-bg, #fff);
        border: 1px solid var(--bs-border-color, #ddd);
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        min-width: 120px;
    ">
        <div class="menu-item mute">ç¦è¨€</div>
        <div class="menu-item unmute">è§£é™¤ç¦è¨€</div>
        <div class="menu-item points">ç§¯åˆ†æ“ä½œ</div>
        <div class="menu-item kick">è¸¢å‡º(ç¦ç”¨)</div>
        <div class="menu-item unkick">è§£é™¤è¸¢å‡º</div>
        <div class="menu-item clear-messages">æ¸…é™¤æ¶ˆæ¯</div>
        <div class="menu-item force-refresh">å¼ºåˆ¶åˆ·æ–°(ç¦ç”¨)</div>
    </div>
`);

// ä¿®æ”¹æ¸…é™¤æ¶ˆæ¯èœå•é¡¹å¤„ç†
$(document).on('click', '.menu-item.clear-messages', function() {
    const options = [
        'æ¸…é™¤æœ€æ–°20æ¡æ¶ˆæ¯',
        'æ¸…é™¤æœ€æ–°50æ¡æ¶ˆæ¯',
        'æ¸…é™¤æ‰€æœ‰æ¶ˆæ¯'
    ];
    
    const choice = prompt(`è¯·é€‰æ‹©æ¸…é™¤é€‰é¡¹ï¼š\n${options.map((opt, idx) => `${idx + 1}. ${opt}`).join('\n')}\n\nè¯·è¾“å…¥é€‰é¡¹ç¼–å·ï¼š`);
    
    if(!choice) return;
    
    let count;
    switch(choice) {
        case '1':
            count = 20;
            break;
        case '2':
            count = 50;
            break;
        case '3':
            count = null;
            break;
        default:
            alert('æ— æ•ˆçš„é€‰é¡¹');
            return;
    }
    
    if(!confirm(`ç¡®å®šè¦${options[choice - 1]}å—ï¼Ÿ`)) return;
    
    $.ajax({
        type: 'POST',
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=clear",
        data: { count: count },
        dataType: 'json',
        success: function(response) {
            if(response.error) {
                alert(response.error);
            } else {
                alert('æ¸…é™¤æˆåŠŸ');
                // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
                get_msg();
            }
        },
        error: function(xhr, status, error) {
            console.error('Clear messages failed:', error);
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
});

// ä¿®æ”¹å¼ºåˆ¶åˆ·æ–°åŠŸèƒ½
function checkForceRefresh() {
    $.ajax({
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=check_refresh",
        dataType: 'json',
        success: function(response) {
            // åªæœ‰å½“æ”¶åˆ°æ–°çš„tokenä¸”ä¸æ˜¯åˆå§‹åŒ–æ—¶æ‰åˆ·æ–°
            if(response.token && window.lastRefreshToken && response.token !== window.lastRefreshToken) {
                window.lastRefreshToken = response.token;
                // æ˜¾ç¤ºé€šçŸ¥å¹¶ç›´æ¥åˆ·æ–°
                const message = document.createElement('div');
                message.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 9999;
                `;
                message.textContent = 'ç®¡ç†å‘˜è¦æ±‚åˆ·æ–°é¡µé¢ï¼Œé¡µé¢å³å°†åˆ·æ–°...';
                document.body.appendChild(message);
                
                // 1ç§’ååˆ·æ–°
                setTimeout(function() {
                    window.location.href = '/chat.htm';
                }, 1000);
            } else if(!window.lastRefreshToken) {
                // åˆå§‹åŒ–token
                window.lastRefreshToken = response.token;
            }
        }
    });
}

// ä¿®æ”¹å¼ºåˆ¶åˆ·æ–°æŒ‰é’®å¤„ç†
$(document).on('click', '.menu-item.force-refresh', function() {
    $.ajax({
        type: 'POST',
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=force_refresh",
        dataType: 'json',
        success: function(response) {
            if(response.error) {
                alert(response.error);
            } else {
                // æ˜¾ç¤ºé€šçŸ¥
                const message = document.createElement('div');
                message.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 4px;
                    z-index: 9999;
                `;
                message.textContent = 'å·²å‘é€å¼ºåˆ¶åˆ·æ–°å‘½ä»¤';
                document.body.appendChild(message);
                
                // 2ç§’åç§»é™¤é€šçŸ¥
                setTimeout(() => message.remove(), 2000);
            }
        }
    });
});

// æ·»åŠ å³èœå•çš„ä»¶å¤„ç†
$(document).on('contextmenu', '.chat-message .text-muted small', function(e) {
    console.log('Right click detected, isAdmin:', window.isAdmin);
    if(!window.isAdmin) {
        return true;
    }
    
    e.preventDefault();
    const username = $(this).text().trim();
    console.log('Selected username:', username);
    
    if(username === name) {
        alert('ä¸èƒ½å¯¹è‡ªå·±æ‰§è¡Œæ­¤æ“ä½œ');
        return;
    }
    
    $('.custom-menu')
        .show()
        .css({
            top: e.pageY + 'px',
            left: e.pageX + 'px'
        })
        .data('username', username);
    
    console.log('Menu shown for user:', username);
});

// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
$(document).click(function() {
    $('.custom-menu').hide();
});

// å¤„ç†èœå•é¡¹ç‚¹å‡»
$(document).on('click', '.custom-menu .menu-item', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const action = $(this).attr('class').split(' ')[1];
    const username = $('.custom-menu').data('username');
    
    console.log('Menu action:', action, 'for user:', username);
    
    if(!username) {
        console.error('No username found');
        return;
    }
    
    switch(action) {
        case 'mute':
            if(confirm(`ç¡®å®šè¦ç¦è¨€ç”¨æˆ· ${username} å—ï¼Ÿ`)) {
                muteUser(username);
            }
            break;
        case 'unmute':
            if(confirm(`ç¡®å®šè¦è§£é™¤ç”¨æˆ· ${username} ç¦è¨€å—ï¼Ÿ`)) {
                unmuteUser(username);
            }
            break;
        case 'points':
            operatePoints(username);
            break;
        case 'kick':
            if(confirm(`ç¡®å®šè¦è¸¢å‡ºç”¨æˆ· ${username} å—ï¼Ÿ`)) {
                kickUser(username);
            }
            break;
        case 'unkick':
            if(confirm(`ç¡®å®šè¦è§£é™¤ç”¨æˆ· ${username} çš„è¸¢å‡ºçŠ¶æ€å—ï¼Ÿ`)) {
                unkickUser(username);
            }
            break;
    }
    
    $('.custom-menu').hide();
});

// æ·»åŠ èœå•é¡¹çš„ hover æ•ˆæœ
$(document).on('mouseenter', '.custom-menu .menu-item', function() {
    $(this).css({
        'background-color': 'var(--bs-primary, #0d6efd)',
        'color': 'var(--bs-white, #fff)'
    });
}).on('mouseleave', '.custom-menu .menu-item', function() {
    $(this).css({
        'background-color': 'var(--bs-body-bg, #fff)',
        'color': 'var(--bs-body-color, #333)'
    });
});

// ç®¡ç†åŠŸèƒ½
function muteUser(username) {
    console.log('Muting user:', username);
    $.ajax({
        type: 'POST',
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=mute",
        data: { username: username },
        dataType: 'json',
        success: function(response) {
            console.log('Mute response:', response);
            if(response.error) {
                alert(response.error);
            } else {
                alert(response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('Mute failed:', error);
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}

function unmuteUser(username) {
    console.log('Unmuting user:', username);
    $.ajax({
        type: 'POST',
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=unmute",
        data: { username: username },
        dataType: 'json',
        success: function(response) {
            console.log('Unmute response:', response);
            if(response.error) {
                alert(response.error);
            } else {
                alert(response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('Unmute failed:', error);
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}

function kickUser(username) {
    console.log('Kicking user:', username);
    $.ajax({
        type: 'POST',
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=kick",
        data: { username: username },
        dataType: 'json',
        success: function(response) {
            console.log('Kick response:', response);
            if(response.error) {
                alert(response.error);
            } else {
                alert(response.message);
                if(username === name) {
                    window.location.reload();
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('Kick failed:', error);
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}

// ä¿®æ”¹æ¸¸æˆç›¸å…³å‡½æ•°
function rollDice() {
    // æŸ¥å¦æœ‰æœªæˆçš„æ¸¸æˆ
    if($('.game-status-box').is(':visible')) {
        alert('è¯·ç­‰å¾…å½“å‰æ¸¸æˆç»“æŸ');
        return;
    }
    
    const points = prompt('è¯·è¾“å…¥ä¸‹æ³¨ç§¯åˆ†(1-1000000):', '100');
    if(points === null) return;
    
    const betPoints = parseInt(points);
    if(isNaN(betPoints) || betPoints < 1 || betPoints > 1000000) {
        alert('è¯·è¾“å…¥1-1000000ä¹‹é—´çš„æœ‰æ•ˆç§¯åˆ†');
        return;
    }
    
    // ç›´æ¥å‘é€æ¸¸æˆè¯·æ±‚ï¼Œä¸äºŒæ¬¡ç¡®è®¤
    $.ajax({
        type: 'POST',
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=game",
        data: { 
            type: 'dice',
            points: betPoints
        },
        dataType: 'json',
        success: function(response) {
            if(response.error) {
                alert(response.error);
            }
        },
        error: function(xhr, status, error) {
            console.error('Game action failed:', error);
            alert('æ¸¸æˆæ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}

// ä¿®æ”¹å­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
$('.chat-toolbar .dice-btn').on('click', function() {
    rollDice();
});

// æ¸¸æˆæŒ‰é’®æ·»åŠ hoveræ•ˆæœ
$('.chat-toolbar .toolbar-btn').hover(
    function() {
        $(this).css({
            'background': 'var(--bs-primary, #0d6efd)',
            'box-shadow': '0 2px 5px rgba(0,0,0,0.15)',
            'border-color': 'var(--bs-primary, #0d6efd)',
            'color': 'var(--bs-white, #fff)'
        });
    },
    function() {
        $(this).css({
            'background': 'var(--bs-body-bg, #fff)',
            'box-shadow': '0 1px 3px rgba(0,0,0,0.1)',
            'border-color': 'var(--bs-border-color, #ddd)',
            'color': 'var(--bs-body-color, #333)'
        });
    }
);

// åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ç§¯åˆ†æ“ä½œå‡½æ•°
function operatePoints(username) {
    if(!window.isAdmin) {
        alert('åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ“ä½œç§¯åˆ†');
        return;
    }
    
    // å¼¹å‡ºè¾“å…¥æ¡†è®©ç®¡ç†å‘˜è¾“å…¥ç§¯åˆ†æ•°é‡
    const points = prompt('è¯·è¾“å…¥è¦æ“ä½œçš„ç§¯åˆ†æ•°é‡\n(æ­£æ•°ä¸ºå¢åŠ ï¼Œè´Ÿæ•°ä¸ºå‡å°‘):', '100');
    if(points === null) return;
    
    const pointsNum = parseInt(points);
    if(isNaN(pointsNum) || pointsNum === 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç§¯åˆ†æ•°å€¼');
        return;
    }
    
    // è¾“å…¥æ“ä½œåŸå› 
    const reason = prompt('è¯·è¾“å…¥æ“ä½œåŸå› (å¯é€‰):');
    if(reason === null) return;
    
    // ç¡®è®¤æ“ä½œ
    const operation = pointsNum > 0 ? 'å¢åŠ ' : 'å‡å°‘';
    const points_abs = Math.abs(pointsNum);
    if(!confirm(`ç¡®è®¤ä¸ºç”¨æˆ· ${username} ${operation} ${points_abs} ç§¯åˆ†å—ï¼Ÿ`)) {
        return;
    }
    
    $.ajax({
        type: 'POST',
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=points",
        data: {
            username: username,
            points: pointsNum,
            reason: reason
        },
        dataType: 'json',
        success: function(response) {
            if(response.error) {
                alert(response.error);
            } else {
                alert('ç§¯åˆ†æ“ä½œæˆåŠŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Points operation failed:', error);
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}

// ä¿®æ”¹å¿«æ‰‹æŒ‰é’®ç›¸å…³ä»£ç 
$(document).ready(function() {
    // å¿«æ‰‹æŒ‰é’®å‡»ä»¶
    $('.kuaishou-btn').on('click', function() {
        $('.kuaishou-popup').fadeToggle();
    });

    // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨æ›´ç›´æ¥çš„æ–¹å¼
    $(document).on('click', '.kuaishou-close', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $('.kuaishou-popup').fadeOut();
        console.log('Close button clicked'); // æ·»åŠ è°ƒè¯•æ—¥å¿—
    });

    // é˜»æ­¢å¿«æ‰‹iframeå†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
    $('.kuaishou-popup iframe').on('click', function(e) {
        e.stopPropagation();
    });
});

// æ·»åŠ è¾“å…¥æ¡†çŠ¶æ€æ¢å¤å‡½æ•°
function resetMessageInput() {
    $("#msg").prop('disabled', false)
                .attr('placeholder', 'è¯·è¾“å…¥æ¶ˆæ¯...')
                .focus();
}

// ä¿®æ”¹æ¶ˆæ¯è·å–å‡½æ•°ï¼Œåœ¨æ”¶åˆ°AIå›å¤åæ¢å¤è¾“å…¥æ¡†çŠ¶æ€
function getMessages() {
    $.ajax({
        url: "./plugin/msto_chat/route/app/ajax.php?c=msg&k=" + k,
        type: "GET",
        dataType: "json",
        success: function(response) {
            if (response.error) {
                console.log(response.error);
                return;
            }
            
            if (response.list && response.list.length > 0) {
                response.list.forEach(function(msgStr) {
                    var msg = JSON.parse(msgStr);
                    if (msg.type === 'ai') {
                        // æ”¶åˆ°AIå›å¤åæ¢å¤è¾“å…¥æ¡†çŠ¶æ€
                        resetMessageInput();
                    }
                    // ... å…¶ä»–æ¶ˆæ¯ç†é€»è¾‘ ...
                });
            }
            
            k = response.count;
        }
    });
}

// æ·»åŠ è§†è§‰åé¦ˆ
function showAITyping() {
    removeAITyping(); // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æç¤º
    var typingHtml = `
        <div class="chat-message left ai-typing">
            <div class="d-flex overflow-hidden">
                <div class="user-avatar flex-shrink-0 me-4">
                    <div class="avatar avatar-sm">
                        <img src="${AI_AVATAR}" alt="AI" class="rounded-circle" onerror="this.src='./plugin/msto_chat/assets/system.png'">
                    </div>
                </div>
                <div class="chat-message-wrapper flex-grow-1">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            </div>
        </div>`;
    
    $(".mk-chat-box").append(typingHtml);
    sockll();
}

function removeAITyping() {
    $(".ai-typing").remove();
}

// åœ¨å‘é€AIæ¶ˆæ¯æ—¶æ˜¾ç¤ºè¾“å…¥çŠ¶æ€
if (message.match(/^@AIåŠ©æ‰‹\s+/i)) {
    showAITyping();
}

// åœ¨æ”¶åˆ°AIå›å¤æ—¶ç§»é™¤è¾“å…¥çŠ¶æ€
if (msg.type === 'ai') {
    removeAITyping();
    resetMessageInput();
}

// æ·»åŠ ç›¸å…³ CSS
const styleSheet = document.createElement("style");
styleSheet.textContent = `
    .typing-indicator {
        padding: 10px;
        display: flex;
        gap: 4px;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background: #90949c;
        border-radius: 50%;
        animation: typing 1s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.4s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.6s; }

    @keyframes typing {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.5); }
    }

    .ai-typing {
        opacity: 0.7;
    }
`;
document.head.appendChild(styleSheet);

// æ·»åŠ Bç«™è§†é¢‘è§£æå‡½æ•°
function parseBilibiliUrl(message) {
    // åŒ¹é…Bç«™è§†é¢‘URLçš„æ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ”¯æŒBVå·å’Œavå·ï¼‰
    const biliRegex = /https?:\/\/(www\.)?(bilibili\.com\/video\/(?:BV[\w]+|av\d+))[^\s]*/i;
    const match = message.match(biliRegex);
    
    if (match) {
        const videoUrl = match[0];
        const bvMatch = videoUrl.match(/\/(BV[\w]+)/);
        const avMatch = videoUrl.match(/\/(av\d+)/);
        const videoId = bvMatch ? bvMatch[1] : (avMatch ? avMatch[1] : null);
        
        if (videoId) {
            // åˆ›å»ºBç«™æ’­æ”¾å™¨iframe
            return `
                <div class="video-container" style="
                    max-width: 100%;
                    width: 300px;
                    margin: 10px 0;
                    border-radius: 8px;
                    overflow: hidden;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    background: #000;
                ">
                    <iframe src="//player.bilibili.com/player.html?bvid=${videoId}&page=1&high_quality=1&danmaku=0&autoplay=0" 
                        scrolling="no" 
                        border="0" 
                        frameborder="no" 
                        framespacing="0" 
                        allowfullscreen="true"
                        style="width:100%;height:200px;"
                        sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts"
                    ></iframe>
                </div>
            `;
        }
    }
    
    return message;
}

// æ·»åŠ æ’¤å›æŒ‰é’®çš„äº‹ä»¶å¤„ç†
$(document).ready(function() {
    // ç¤º/éšè—æ’¤å›æŒ‰é’®
    $(document).on('mouseenter', '.chat-message', function() {
        $(this).find('.recall-btn').css('opacity', '1');
    }).on('mouseleave', '.chat-message', function() {
        $(this).find('.recall-btn').css('opacity', '0');
    });
    
    // æ’¤å›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $(document).on('click', '.recall-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const messageId = $(this).data('message-id');
        if(!messageId) {
            console.error('No message ID found');
            return;
        }
        
        if(!confirm('ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;
        
        const baseUrl = document.querySelector('.mk-chat-box').getAttribute('data-base-href');
        
        $.ajax({
            type: 'POST',
            url: baseUrl + "app/ajax.php?c=recall",
            data: { messageId: messageId },
            dataType: 'json',
            success: function(response) {
                if(response.error) {
                    alert(response.error);
                } else {
                    console.log('æ¶ˆæ¯æ’¤å›æˆåŠŸ');
                    // ä»æœ¬åœ°è®°å½•ä¸­ç§»é™¤æ¶ˆæ¯ID
                    messageIds.delete(messageId);
                    // ç§»é™¤æ¶ˆæ¯å…ƒç´ 
                    $(e.target).closest('.chat-message').fadeOut(function() {
                        $(this).remove();
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error('æ’¤å›å¤±è´¥:', error);
                console.error('æœåŠ¡å™¨å“åº”:', xhr.responseText);
                alert('æ’¤å›å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });
    });
});

// æ·»åŠ è§£é™¤è¸¢å‡ºçš„å¤„ç†å‡½æ•°
function unkickUser(username) {
    console.log('Unkicking user:', username);
    $.ajax({
        type: 'POST',
        url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=unkick",
        data: { username: username },
        dataType: 'json',
        success: function(response) {
            console.log('Unkick response:', response);
            if(response.error) {
                alert(response.error);
            } else {
                alert(response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('Unkick failed:', error);
            alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    });
}

// åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ å›¾ç‰‡æŸ¥çœ‹å™¨ç›¸å…³ä»£ç 
$(document).ready(function() {
    // å›¾ç‰‡ç‚¹å‡»æ”¾
    $(document).on('click', '.chat-message img:not(.rounded-circle)', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const imgSrc = $(this).attr('src');
        $('.image-viewer img').attr('src', imgSrc);
        $('.image-viewer').fadeIn();
    });

    // ç‚¹å‡»èƒŒæ™¯å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
    $('.image-viewer').on('click', function() {
        $(this).fadeOut();
    });

    // é˜»æ­¢å›¾ç‰‡ç‚¹äº‹ä»¶å†’æ³¡
    $('.image-viewer img').on('click', function(e) {
        e.stopPropagation();
    });

    // æ·»åŠ ç²˜è´´å›¾ç‰‡åŠŸèƒ½
    $('#msg').on('paste', function(e) {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        
        for (let item of items) {
            if (item.type.indexOf('image') === 0) {
                e.preventDefault();
                
                const blob = item.getAsFile();
                const formData = new FormData();
                formData.append('image', blob);

                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                $('body').append(`
                    <div class="upload-progress" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 20px;
                        border-radius: 5px;
                        z-index: 1000;
                    ">
                        <div>æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...</div>
                        <div class="progress-text">0%</div>
                    </div>
                `);

                $.ajax({
                    url: document.querySelector('.mk-chat-box').getAttribute('data-base-href') + "app/ajax.php?c=upload",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    xhr: function() {
                        const xhr = new XMLHttpRequest();
                        xhr.upload.addEventListener("progress", function(e) {
                            if(e.lengthComputable) {
                                const percent = Math.round((e.loaded / e.total) * 100);
                                $('.progress-text').text(percent + '%');
                            }
                        });
                        return xhr;
                    },
                    success: function(response) {
                        $('.upload-progress').remove();
                        
                        if(response.error) {
                            alert(response.error);
                            return;
                        }
                        if(response.url) {
                            const imgMsg = `<img src="${response.url}" style="max-width:200px; max-height:200px; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.2);" />`;
                            $("#msg").val(imgMsg);
                            send();
                        }
                    },
                    error: function(xhr, status, error) {
                        $('.upload-progress').remove();
                        console.error('Upload failed:', error);
                        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });
            }
        }
    });
});

